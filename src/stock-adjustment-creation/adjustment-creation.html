<h2>
  {{vm.key('title') |
  message:{'facilityCode': vm.facility.code, 'facilityName': vm.facility.name, 'program': vm.program.name} }}
</h2>

<div class="stock-adjustment-creation">
  <section class="openlmis-table-container">
    <form ng-submit="vm.search()">
      <fieldset>
        <label for="search">{{vm.key('keyword') | message}}</label>
        <input id="search" type="text" ng-model="vm.keyword" maxlength="50"/>
      </fieldset>

      <input type="submit" value="{{vm.key('search') | message}}"/>
    </form>

    <section>
      <form class="form-inline" ng-submit="vm.addProduct()">

        <fieldset>
          <label for="productSelect">{{vm.key('product') | message}}</label>
          <select id="productSelect" ng-model="vm.selectedOrderableGroup"
                  ng-options="orderableGroup[0].orderable.fullProductName for orderableGroup in vm.orderableGroups"
                  required>
          </select>
        </fieldset>

        <fieldset ng-if="vm.hasLot">
          <label for="lotSelect">{{'stockAddProductsModal.lotCode' | message}}</label>
          <select id="lotSelect" ng-model="vm.selectedLot"
                  ng-options="lot.lotCode for lot in vm.lotsOf(vm.selectedOrderableGroup)">
          </select>
        </fieldset>

        <fieldset>
          <label for="reason">{{vm.key('reason') | message}}</label>
          <select id="reason" ng-model="vm.selectedReason" ng-change="vm.clearFreeText(vm)"
                  ng-options="reason.name for reason in vm.reasons" required>
          </select>
        </fieldset>

        <fieldset ng-show="vm.selectedReason.isFreeTextAllowed">
          <label for="reasonFreeText">{{vm.key('reasonComments') | message}}</label>
          <textarea id="reasonFreeText" rows="1" cols="15" ng-model="vm.reasonFreeText"></textarea>
        </fieldset>

        <fieldset>
          <label for="date" class="required">{{vm.key('date') | message}}</label>
          <openlmis-datepicker
            input-id="date" value="vm.selectedOccurredDate"
            max-date="vm.maxDate" required></openlmis-datepicker>
        </fieldset>

        <button type="submit">{{vm.key('add') | message}}</button>
      </form>
    </section>

    <table>
      <caption ng-if="!vm.displayItems.length">
        {{vm.key('noProducts') | message}}
      </caption>
      <thead>
      <tr>
        <th>{{vm.key('productCode') | message}}</th>
        <th>{{vm.key('product') | message}}</th>
        <th ng-show="vm.hasLot">{{vm.key('lotCode') | message}}</th>
        <th ng-show="vm.hasLot">{{vm.key('expiryDate') | message}}</th>
        <th>{{vm.key('soh') | message}}</th>
        <th>{{vm.key('reason') | message}}</th>
        <th>{{vm.key('quantity') | message}}</th>
        <th>{{vm.key('date') | message}}</th>
        <th>{{vm.key('actions') | message}}</th>
      </tr>
      </thead>
      <tbody>
      <tr ng-class="{'align-top': lineItem.reason.isFreeTextAllowed}"
          ng-repeat="lineItem in vm.items track by $index">
        <td>{{lineItem.orderable.productCode}}</td>
        <td>{{lineItem.orderable | productName}}</td>
        <td ng-show="vm.hasLot">
          {{lineItem.lot?lineItem.lot.lotCode:(vm.key('noLotDefined') |
          message)}}
        </td>
        <td ng-show="vm.hasLot">{{lineItem.lot.expirationDate | openlmisDate}}</td>
        <td align="right">{{lineItem.stockOnHand}}</td>
        <td>
          <select ng-model="lineItem.reason" ng-change="vm.clearFreeText(lineItem)"
                  ng-options="reason.name for reason in vm.reasons" required>
          </select>
          <div ng-show="lineItem.reason.isFreeTextAllowed">
            <br>
            <textarea rows="1" cols="15" ng-model="lineItem.reasonFreeText"> </textarea>
          </div>
        </td>
        <td popover="{{lineItem.quantityInvalid}}" class="soh-cell">
          <input class="form-control" ng-model="lineItem.quantity" ng-class="{'error': lineItem.quantityInvalid}"
                 ng-change="vm.validateQuantity(lineItem)" ng-blur="vm.validateQuantity(lineItem)"
                 positive-integer/>
        </td>
        <td class="date-cell">
          <openlmis-datepicker input-id="lineItem.occurredDate" value="lineItem.occurredDate"
                               max-date="vm.maxDate"></openlmis-datepicker>
        </td>
        <td>
          <button type="button" class="danger" ng-click="vm.remove(lineItem)">
            {{vm.key('remove') | message}}
          </button>
        </td>
      </tr>
      </tbody>
    </table>
    <openlmis-pagination list="vm.displayItems" paged-list="vm.items"></openlmis-pagination>
  </section>
</div>

<ng-include src="'stock-adjustment-creation/adjustment-creation-toolbar.html'"></ng-include>
